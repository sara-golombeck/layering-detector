name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Stage 1: Test
  test:
    name: Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install -r requirements-test.txt
        pip install -e .
    
    - name: Run unit tests
      run: pytest tests/ -v

  # Stage 2: Package
  package:
    name: Package
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    outputs:
      version: ${{ steps.version.outputs.version }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Generate version
      id: version
      run: |
        LATEST_TAG=$(git tag --sort=-version:refname | head -1 2>/dev/null || echo "")
        
        if [ -z "$LATEST_TAG" ]; then
          NEW_VERSION="1.0.0"
        else
          IFS='.' read -r major minor patch <<< "$LATEST_TAG"
          NEW_VERSION="$major.$minor.$((patch + 1))"
        fi
        
        echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "Generated version: $NEW_VERSION"
    
    - name: Build Docker image
      run: |
        docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }} .
        docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }} ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
    
    - name: Save image artifact
      run: |
        mkdir -p /tmp/docker
        docker save ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }} | gzip > /tmp/docker/image.tar.gz
    
    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: docker-image
        path: /tmp/docker/image.tar.gz
        retention-days: 1

  # Stage 3: Publish
  publish:
    name: Publish
    runs-on: ubuntu-latest
    needs: package
    permissions:
      packages: write
    
    steps:
    - name: Download artifact
      uses: actions/download-artifact@v3
      with:
        name: docker-image
        path: /tmp/docker
    
    - name: Load image
      run: |
        docker load < /tmp/docker/image.tar.gz
        docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.package.outputs.version }} ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
    
    - name: Log in to Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Push to Registry
      run: |
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.package.outputs.version }}
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
        echo "Published version: ${{ needs.package.outputs.version }}"

  # Stage 4: Release
  release:
    name: Release
    runs-on: ubuntu-latest
    needs: [package, publish]
    permissions:
      contents: write
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Create Git tag
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag ${{ needs.package.outputs.version }}
        git push origin ${{ needs.package.outputs.version }}
        echo "Released version: ${{ needs.package.outputs.version }}"